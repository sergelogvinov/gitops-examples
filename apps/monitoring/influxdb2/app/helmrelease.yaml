---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: influxdb
spec:
  interval: 60m
  timeout: 10m

  maxHistory: 2
  driftDetection:
    mode: enabled

  chart:
    spec:
      chart: influxdb2
      version: 2.1.2
      sourceRef:
        kind: HelmRepository
        name: influxdata
        namespace: flux-system
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3

  valuesFrom:
    - kind: ConfigMap
      name: influxdb-helm-values
    - kind: Secret
      name: influxdb-helm-values
      optional: true
  values:
    fullnameOverride: influxdb

    ingress:
      tls: true
      className: ${CLUSTER_INGRESS_CLASS}
      secretName: influxdb.${CLUSTER_DOMAIN}-tls
      hostname: influxdb.${CLUSTER_DOMAIN}

    securityContext:
      seccompProfile:
        type: RuntimeDefault
      runAsNonRoot: true
      runAsUser: 1000
      runAsGroup: 1000
      fsGroup: 1000
      fsGroupChangePolicy: "OnRootMismatch"

    livenessProbe:
      initialDelaySeconds: 60

    readinessProbe:
      initialDelaySeconds: 30
